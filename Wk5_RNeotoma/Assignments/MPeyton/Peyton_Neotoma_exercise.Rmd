---
title: "Peyton Neotoma Exercise"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

####Exercise 1: Comment line: http://api.neotomadb.org/v1/data/sites?sitename=*fallison*

Calls 2 sites: "Fallison Lake" & "Fallison Bog (Trout D)"

####Exercise 2: "datasets" comment line: http://api.neotomadb.org/v1/data/datasets?datasettype=pollen
Returns all pollen datasets

"downloads" comment line: http://api.neotomadb.org/v1/data/downloads/215 Returns the complete dataset from dataset ID 215

####Exercise 3 http://api.neotomadb.org/v1/dbtables/Geochronology?limit=50&offset=0 Returns the first 50 records (#0 - #49) from the geochronology table

##Importing Neotoma Data into R and *neotoma*

```{r}
library(neotoma)
?get_site #Just looking at the help window for the function get_site
fallison <- get_site("Fallison Lake") #Pulled down the metadata for Fallison Lake site
print(fallison)
```

####Exercise 4: How many sites have the name "clear" in them?
```{r}
clear <- get_site(sitename = "clear%")
str(clear)
```
  40 sites have the name "clear" in them.
  
Other parameters for finding sites
```{r}
FL_sites <- get_site(loc = c(-88, -79, 25, 30)) #Florida sites (roughly)
NM_sites <- get_site(gpid = 7956) #New Mexico
NM_sites <- get_site(gpid = "New Mexico") #New Mexico
```
  ####Exercise 5: Which state (MN or WI) has more sites?
  
```{r}
mn <- get_site(gpid = "Minnesota") #MN sites
wi <- get_site(gpid = "Wisconsin") #WI sites
length(mn$site.name) - length(wi$site.name) #Number of MN sites - number of WI sites
```

Minnesota has more (+59) sites than Wisconsin.


##Using get_dataset

```{r}
class(fallison); fallison.dataset <- get_dataset(fallison) #Used previous object "fallison" with class = site.
str(fallison.dataset) #View structure
```

####Exercise 6: How many different kinds of datasets are available at Devil's Lake, WI?

```{r}
dlake <- get_site(sitename = "Devil%")
dlake #Looking at lat lon, it appears the second site is the Devil's Lake from WI we're looking for. lon = -89.73205, lat = 4341780
dlake <- get_site(sitename = "Devils Lake", loc = c(-89.8, -89.7, 43.4, 43.5)) #Found Devil's Lake, WI
dlake.dataset <- get_dataset(dlake) #Get dataset for Devil's Lake
print(dlake.dataset)
dlake.dataset #Contains 5 datasets
```
  In total there are 5 available types of datasets for this site.
  
##Using get_download

```{r}
devils1 <- get_download(dlake) #Retrieve from class = sites
devils2 <- get_download(dlake.dataset) #Retrieve from class = dataset
head(devils1[[1]]$counts, n = 2) #Lets look at the first few values of the counts data in the first dataset
devils_pollen_p25 <- compile_taxa(devils1[[1]], list.name = "P25") #Compile Devil's lake pollen using P25 taxon list
devils_pollen_p25$taxon.list[,c("compressed", "taxon.name")] #Let's see which taxa were converted
names(devils_pollen_p25) #New object called "full.counts" has been added to our download object
```


##Using analogue package

```{r}
library(analogue)
#Convert counts to percentages using analogue
devil_pollen_pct <- analogue::tran(x = devils1[[1]]$counts, method = "percent")
#Keep only common taxa (>2%)
devil_pollen_pct_norare <- devil_pollen_pct[, colMeans(devil_pollen_pct, na.rm = TRUE) > 2]
#Make a pollen diagram in analogue
analogue::Stratiplot(x = devil_pollen_pct_norare[ , order(colMeans(devil_pollen_pct_norare, na.rm = TRUE),  decreasing = TRUE)], y = devils1[[1]]$sample.meta$age,  ylab = devils1[[1]]$sample.meta$age.type[1],  xlab = " Pollen Percentage")
```


####Exercise 7: Make a stratigraphic pollen diagram for another site

Site chosen: Lake Mendota

```{r}
men_site <- get_site(sitename = "Lake Mendota") #Get site
str(men_site) #Take a look at structure
men_data <- get_download(men_site) #Downlod the data
men_data #Looks like we have two pollen datasets here

#Clean the data (using one core)
men_pollen <- men_data[[1]]$counts #Isolate the pollen counts
men_pollen_per <- analogue::tran(x = men_pollen, method = "percent")
#Keep only the common taxa (>2%)
men_pollen_clean <- men_pollen_per[, colMeans(men_pollen_per, na.rm = TRUE) > 2]
#Construct a pollen diagram in analogue
analogue::Stratiplot(men_pollen_clean[, order(colMeans(men_pollen_clean, na.rm = TRUE), decreasing = TRUE)], y = men_data[[1]]$sample.meta$age,  ylab = men_data[[1]]$sample.meta$age.type[1],  xlab = " Pollen Percentage")
#Using rioja
rioja::strat.plot(men_pollen_clean, xlab = "Pollen Percentages")
```

##Multiple Sites

Hemlock exercise
```{r}
# Search for datasets with Tsuga in them
hem_dec <- get_dataset(taxonname = "Tsuga*",
                       datasettype = "pollen",
                       loc = c(-98.6, 36.5, -66.1, 49.75),
                       ageyoung = 4500, ageold = 6000)
# Download the datasets (this will take a few minutes)
hem_dec_dl <- get_download(hem_dec)
library(rworldmap) #Load worldmap package
map <- getMap()
plot(hem_dec) 
plot(map, add = TRUE)
hem_compiled <- compile_downloads(hem_dec_dl) #Combine records
# Extract all taxon tables from the original download object  
all_taxa <- do.call(rbind.data.frame, lapply(hem_dec_dl, function(x)x$taxon.list[,1:6]))

# Remove duplicate names
all_taxa <- all_taxa[!duplicated(all_taxa),]

# Limit the taxa to everything that is a tree or shrub, or upland herbs. (This information is stored within a field called `ecological.group` )
# Because columns in R by default change all punctuation and spaces to periods we have
#  to use regular-expression commands to change spaces `[ ]` and punctuation
#  `[[:punct:]]` to a period using the `gsub` command.

good_cols <- c(1:10, which(colnames(hem_compiled) %in%
      gsub("[ ]|[[:punct:]]", ".",
      all_taxa[all_taxa$ecological.group %in%
      c("TRSH", "UPHE"),1])))

# Take just those trees, shrubs & herbs and transform counts to proportions:
hem_compiled <- hem_compiled[ ,good_cols]

hem_pct <- hem_compiled[,11:ncol(hem_compiled)] / rowSums(hem_compiled[,11:ncol(hem_compiled)],             na.rm = TRUE)

hem_only <- rowSums(hem_pct[,grep("Tsuga", colnames(hem_pct))], na.rm = TRUE)
age_cols <- grep("^age", colnames(hem_compiled))

hemlock_all <- data.frame(ages = rowMeans(hem_compiled[,age_cols], na.rm = TRUE),
                          prop = hem_only)

plot(hemlock_all, col = rgb(0.1, 0.1, 0.1, 0.3), pch = 19, cex = 0.4,
     xlim = c(0, 20000),
     ylab = "Proportion of Hemlock",          xlab = "Years Before Present")
plot(hemlock_all,
     col = c(rgb(0.1, 0.1, 0.1, 0.3),
             rgb(1, 0, 0, 0.3))[(hem_compiled$date.type == "Radiocarbon years BP") + 1],
     pch = 19, cex = 0.4,
     xlim = c(0, 20000),
     ylab = "Proportion of Hemlock", xlab = "Years Before Present")
```


####Exercise 8: Repeat the above activity for a different taxon

 I will use *Picea* as my taxon of choice

```{r}
# Search for datasets with Picea in them
picea <- get_dataset(taxonname = "Picea*",
                       datasettype = "pollen",
                       loc = c(-98.6, 36.5, -66.1, 49.75),
                       ageyoung = 4500, ageold = 6000)
# Download the datasets
picea_dl <- get_download(picea)
map <- getMap()
plot(picea_dl) 
plot(map, add = TRUE) #Make map
picea_compiled <- compile_downloads(picea_dl) #Combine records
# Extract all taxon tables from the original download object  
all_taxa <- do.call(rbind.data.frame, lapply(picea_dl, function(x)x$taxon.list[,1:6]))
summary(all_taxa)

# Remove duplicate names
all_taxa <- all_taxa[!duplicated(all_taxa),]

good_cols <- c(1:10, which(colnames(picea_compiled) %in%
      gsub("[ ]|[[:punct:]]", ".",
      all_taxa[all_taxa$ecological.group %in%
      c("TRSH", "UPHE"),1])))

# Take those groups, transform to percentages
picea_compiled <- picea_compiled[ ,good_cols]

picea_pct <- picea_compiled[,11:ncol(picea_compiled)] / rowSums(picea_compiled[,11:ncol(picea_compiled)],             na.rm = TRUE)

picea_only <- rowSums(picea_pct[,grep("Picea", colnames(picea_pct))], na.rm = TRUE)
age_cols <- grep("^age", colnames(picea_compiled))

picea_all <- data.frame(ages = rowMeans(picea_compiled[,age_cols], na.rm = TRUE),
                          prop = picea_only)

plot(picea_all, col = rgb(0.1, 0.1, 0.1, 0.3), pch = 19, cex = 0.4,
     xlim = c(0, 20000),
     ylab = "Proportion of Picea",          xlab = "Years Before Present")
plot(picea_all,
     col = c(rgb(0.1, 0.1, 0.1, 0.3),
             rgb(1, 0, 0, 0.3))[(picea_compiled$date.type == "Radiocarbon years BP") + 1],
     pch = 19, cex = 0.4,
     xlim = c(0, 20000),
     ylab = "Proportion of Picea", xlab = "Years Before Present")
```


##Fun with For-Loops

First let's look at the Tsuga example:

```{r}
one_slice <- get_dataset(taxonname='Tsuga*', loc=c(-150, 20, -100, 60), ageyoung = 0, ageold = 500) #Extract data from West Coast
increment <- seq(from = 0, to = 10000, by = 500)
one_slice <- get_dataset(taxonname = 'Tsuga*', 
                         loc = c(-150, 20, -100, 60),
                         ageyoung = increment[1],
                         ageold = increment[2])
for(i in 1:20){one_slice <- get_dataset(taxonname = 'Tsuga*', datasettype = 'pollen', loc = c(-150, 20, -100, 60),ageyoung = increment[i], ageold = increment[i + 1])}
site_nos <- rep(NA, 20) 
for(i in 1:20){one_slice <- get_dataset(taxonname = 'Tsuga*', datasettype = 'pollen', loc = c(-150, 20, -100, 60), ageyoung = increment[i], ageold = increment[i + 1]) 
site_nos[i] <- length(one_slice)}
plot(increment[-1], site_nos)

site_lat <- rep(NA, 20)
for (i in 1:20) {all_site <- get_site(get_dataset(taxonname = "Tsuga*", datasettype = "pollen", loc = c(-150, 20, -100, 60), ageyoung = increment[i], ageold = increment[i + 1]))
site_lat[i] <- mean(all_site$lat)}
```


####Exercise 9: Repeat the process for Picea for the last 21,000 years in the upper Midwest

```{r}
call <- get_dataset(taxonname='Picea*', loc=c(-104, 40, -83, 50), ageyoung = 0, ageold = 500) #Extract data from Upper Midwest
increment <- seq(from = 0, to = 10000, by = 500)
call <- get_dataset(taxonname = 'Picea*', 
                         loc = c(-104, 40, -83, 50),
                         ageyoung = increment[1],
                         ageold = increment[2])
for(i in 1:20){call <- get_dataset(taxonname = 'Picea*', datasettype = 'pollen', loc = c(-104, 40, -83, 50),ageyoung = increment[i], ageold = increment[i + 1])}
site_n <- rep(NA, 20) 
for(i in 1:20){call <- get_dataset(taxonname = 'Picea*', datasettype = 'pollen', loc = c(-104, 40, -83, 50), ageyoung = increment[i], ageold = increment[i + 1]) 
site_n[i] <- length(call)}
plot(increment[-1], site_n) #Plot

site_lat <- rep(NA, 20)
for (i in 1:20) {site_all <- get_site(get_dataset(taxonname = "Picea*", datasettype = "pollen", loc = c(-104, 40, -83, 50), ageyoung = increment[i], ageold = increment[i + 1]))
site_lat[i] <- mean(site_all$lat)}
```

