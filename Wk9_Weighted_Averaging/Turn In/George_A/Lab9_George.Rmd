---
title: "Lab9_George"
output: html_document
---
**Question 2**
```{r}
library(palaeoSig)
library(vegan)
library(analogue)
library(rioja)
data(arctic.pollen)
data("arctic.env")
arctic_sqrt <- sqrt(arctic.pollen)
arctic_cca_tmin <- vegan::cca(arctic_sqrt ~ arctic.env$tmin)
arctic_cca_tmin_sum <- summary(arctic_cca_tmin)
arctic_cca_tmin_sum$cont

arctic_cca_tmax <- vegan::cca(arctic_sqrt ~ arctic.env$tmax)
arctic_cca_tmax_sum <- summary(arctic_cca_tmax)
arctic_cca_tmax_sum$cont

arctic_cca_pann <- vegan::cca(arctic_sqrt ~ arctic.env$ptotal)
arctic_cca_pann_sum <- summary(arctic_cca_pann)
arctic_cca_pann_sum$cont
```
tmax explains the most variance, because the ratio of CCA1/CA1 is the highest,

```{r}
arctic_cca_tjul <- vegan::cca(arctic_sqrt ~ arctic.env$tjul)
arctic_cca_tjul_sum <- summary(arctic_cca_tjul)
arctic_cca_tjul_sum$cont

arctic_cca_tjan <- vegan::cca(arctic_sqrt ~ arctic.env$tjan)
arctic_cca_tjul_sum <- summary(arctic_cca_tjul)
arctic_cca_tjul_sum$cont

varpart(arctic_sqrt, arctic.env$tjul, arctic.env$tjan)
```
The shared variance explained for July and January temperature is 26.8%Â  The variance explained by July temp is 22.9 percent and by January temp is 3.1%.

```{r}
arctic_cca_climate <- vegan::cca(arctic_sqrt ~ arctic.env$tjan + arctic.env$tjul + arctic.env$ptotal + arctic.env$sjul)
arctic_cca_clim_sum <- summary(arctic_cca_climate)
arctic_cca_clim_sum$cont
```
January and July temperatures, annual precipitation and July sunshine explain 39.6% of the variance in the arctic pollen dataset.

```{r}
# Creates triplot with temperature 
plot(arctic_cca_climate)

# Adds ordination for each environmental variable
vegan::ordisurf(x = arctic_cca_climate, arctic.env$tjan)
vegan::ordisurf(x = arctic_cca_climate, arctic.env$tjul)
vegan::ordisurf(x = arctic_cca_climate, arctic.env$ptotal)
vegan::ordisurf(x = arctic_cca_climate, arctic.env$sjul)
```
All the variables are explaining different directions of variance in the data. The july temperature and total precipitation point in approximately the same direction. January and July temperature are also relatively close.

**Question 3**
```{r}
# Subsets 4 species of interest from arctic pollen data
subset <- arctic.pollen[,c(13,7,25,26)]

# Estimate WA optima and tolerances for chosen taxa
subset_optima <- analogue::optima(subset, arctic.env$tjul)
subset_tolerance <- tolerance(subset, arctic.env$tjul)

# Plots abundances of taxa as function of July temp with unimodal response
plot(arctic.env$tjul, arctic.pollen[,c(13)], xlab = 'F.CYPE Abundance')
lines(arctic.env$tjul,(dnorm(arctic.env$tjul,subset_optima[1],subset_tolerance[1])*100))

plot(arctic.env$tjul, arctic.pollen[,c(7)], xlab = 'F.PPIN Abundance')
lines(arctic.env$tjul,(dnorm(arctic.env$tjul,subset_optima[2],subset_tolerance[2])*100))

plot(arctic.env$tjul, arctic.pollen[,c(25)], xlab = 'F.PPIN Abundance')
lines(arctic.env$tjul,(dnorm(arctic.env$tjul,subset_optima[3],subset_tolerance[3])*100))

plot(arctic.env$tjul, arctic.pollen[,c(26)], xlab = 'F.PPIN Abundance')
lines(arctic.env$tjul,(dnorm(arctic.env$tjul,subset_optima[4],subset_tolerance[4])*100))
```
```{r}
# Runs WA and summarizes results
arctic_WA <- rioja::WA(arctic_sqrt, arctic.env$tjul)
arctic_WA_sum <- summary(arctic_WA)

# Estimates July temperature optima for all taxa in the arctic pollen dataset 
arctic_optima <- analogue::optima(arctic.pollen, arctic.env$tjul)

plot(arctic_optima, arctic_cca_tjul$CCA$v)
```

The Arctic pollen optima  line up quite well with the species scores calculated for the CCA. 

```{r}
# Predict July temperatures
arctic_WA_predict <- predict(arctic_WA)

# Compares predicted July temps to CCA site scores
plot(arctic_cca_tjul$CCA$u, arctic_WA_predict[,1])
```
There's a reasonably strong correlation between the CCA site scores and the WA predicted July temperatures

```{r}

# Compare apparent and cross-validated (crossval(my.wa.model)) predictions of July temperature. Also compare performance statistics (performance(my.cv.wa.model)).
arctic_WA_cv <- rioja::crossval(arctic_WA)
plot(arctic_WA_cv$predicted[,1], arctic_WA_predict[,1])

arctic_WA_perf <- rioja::performance(arctic_WA)
arctic_WA_cv_perf <- rioja::performance(arctic_WA_cv)
arctic_WA_cv_perf
```
The performance statistics are overall very similar. The average bias for the cross-validated model is higher.
```{r}
# Compare your MAT based reconstruction (week 8) to a WA based reconstruction of the same enironmental variable for the same site.

# Plot WA results
plot(arctic_WA)
title(main = "Arctic Pollen WA")

# Downloads modern pollen and climate data
data(Pollen)
data(Climate)

# Assigns climate variables to vectors
t_max <- Climate[,26]
# Cleans counts
Pollen_corrected <- replace(Pollen,is.na(Pollen),0)
# Calculates pollen percentages
Pollen_percentages <- 100*(Pollen_corrected/rowSums(Pollen_corrected))

# Runs MAT on modern pollen percentages and max temp
MAT.t_max <- rioja::MAT(Pollen_percentages, t_max, lean = FALSE)
# Plots MAT results
plot(MAT.t_max)
title(main = "Arctic Pollen MAT")

# cross-validates the MAT using the leave-one-out technique
cv.tmax.mat.model <- rioja::crossval(MAT.t_max, cv.method='lgo', verbose=FALSE)
cv.tmax.mat.model
# Determines RMSE, performance statistics, and cross-validated predictions' performance
perf.cv.tmax.mat.model <- rioja::performance(cv.tmax.mat.model)
perf.cv.tmax.mat.model

```
The MAT model is much more tightly grouped along a one-to-one line than the WA.
