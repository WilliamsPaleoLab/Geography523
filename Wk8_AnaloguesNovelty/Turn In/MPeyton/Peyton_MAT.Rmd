---
title: "MAT and Novelty Peyton"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE, include=FALSE}
library(neotoma)
library(palaeoSig)
library(vegan)
library(analogue)
library(rioja)
library(maps)
```

###1. Obtain a fossil pollen dataset from neotoma

```{r}
glimm.site <- get_site(sitename = "Glimmerglass Lake")
glimm <- get_download(glimm.site)
head(str(glimm))
summary(glimm[[1]])
head(glimm[[1]]$counts)
```

Ok, looks like we found our fossil pollen dataset (from Sylvania Wilderness). Now let's get our modern dataset (from the NAMPD).

```{r}
data(Pollen) #Modern N American pollen dataset
data(Climate)
data(Location)
colnames(Climate)[1:3] <- c('tjan','tfeb','tmar')
```

###2. Data handling

```{r}
#Change to proportions for NAMPD
Pollen.corrected <- replace(Pollen,is.na(Pollen),0)
mod.per <- (Pollen.corrected/rowSums(Pollen.corrected))*100
#Change to proportions for fossil set
fossil.pollen <- replace(glimm[[1]]$counts, is.na(glimm[[1]]$counts),0)
fossil.per <- (fossil.pollen/rowSums(fossil.pollen))*100
```

Let's reduce the fossil pollen dataset to a manageable size. We will exclude taxa with <10% pollen.

```{r}
pollen.sum <- colSums(fossil.per)
fossil.per <- fossil.per[,pollen.sum > 10]
head(fossil.per) #These taxa remain
fossil.per <- (fossil.per/rowSums(fossil.per))*100 #Make sure the percentages add up to 100%
```

Now we need to pull out the species in the modern pollen dataset that match the fossil dataset.

```{r}
fossil.per <- data.frame(fossil.per)
head(fossil.per) #Lets see what taxa we have
fossil.per$Myriophyllum <- NULL #Take out aquatics
head(mod.per) #Lets see what they look like in the NAMPD
colnames(mod.per) <- tolower(colnames(mod.per)) #Lowercase
colnames(fossil.per) <- tolower(colnames(fossil.per)) #Lowercase
#We need to combine to fossil pinus percentages
fossil.per$pinus <- fossil.per$pinus.banksiana + fossil.per$pinus.strobus + fossil.per$pinus.undiff.
fossil.per$pinus.banksiana <- NULL
fossil.per$pinus.strobus <- NULL
fossil.per$pinus.undiff. <- NULL
#Now lets arrange the modern set to be in the order of the fossil set
modern <- data.frame(mod.per$acsacrum, mod.per$alnusx, mod.per$artemisia, mod.per$betula, mod.per$quercus, mod.per$tsugax, mod.per$abies, mod.per$ambrosia, mod.per$juglansx, mod.per$piceax, mod.per$fraxinux, mod.per$ostrycar, mod.per$ulmus, mod.per$equisetu, mod.per$pinusx)
#Change so total percents = 100
modern <- modern/rowSums(modern)*100
#Change names so they match
colnames(modern) <- colnames(fossil.per)
```


A little messy but we now have a modern and fossil dataset that match in their column names and orders

###3. Pick 3 environmental variables


```{r}
head(Climate) #Let's take a look at our options
```

Looks like the 3 variables which would likely most strongly affect vegetation would be: mean temp of coldest month (mtco), mean temp of warmest month (mtwa), and mean annual precip (annp). Let's use those variables and run some calibrations.

```{r}
#First lets isolate the variables we want to look at
clim <- data.frame(Climate$mtco, Climate$mtwa, Climate$annp)
colnames(clim) <- c("mtco", "mtwa", "annp")

cold.mod <- rioja::MAT(mod.per, clim$mtco, dist.method = "sq.chord", lean = FALSE) #MAT for coldest month
warm.mod <- rioja::MAT(mod.per, clim$mtwa, dist.method = "sq.chord", lean = FALSE) #MAT for warmest month
precip.mod <- rioja::MAT(mod.per, clim$annp, dist.method = "sq.chord", lean = FALSE) #MAT for mean annual precip

plot(cold.mod)
plot(warm.mod)
plot(precip.mod)
summary(cold.mod)
```

Let's do a leave-one-out k-fold cross-validation and take a look at how well these models perform.

```{r}
cal.cold.mod <- rioja::crossval(cold.mod, cv.method = 'lgo' , verbose = FALSE, k = 5) #Cold
cal.warm.mod <- rioja::crossval(warm.mod, cv.method = "lgo", verbose = FALSE, k = 5) #Warm
cal.precip.mod <- rioja::crossval(warm.mod, cv.method = "lgo", verbose = FALSE, k = 5)
plot(cal.cold.mod)
plot(cal.warm.mod)
plot(cal.precip.mod)
perf.cold.mod <- rioja::performance(cal.cold.mod)
perf.warm.mod <- rioja::performance(cal.warm.mod)
perf.precip.mod <- rioja::performance(cal.precip.mod)
perf.cold.mod
perf.warm.mod
perf.precip.mod
```

Let's use this transfer function to reconstruct our climate variables using the fossil dataset.

```{r}
layout(matrix(c(1,2,3), ncol = 1))
depth <- glimm[[1]]$sample.meta$depth #Get depth
age <- glimm[[1]]$sample.meta$age #Age too in case I end up using it
pred.cold <- predict(cold.mod, fossil.per)
pred.warm <- predict(warm.mod, fossil.per)
pred.precip <- predict(precip.mod, fossil.per)
summary(pred.precip) #What do they look like?

#Plot all three using depth
plot(depth, pred.cold$fit[,'MAT'], type = 'l', ylab = 'T [C]', main = "Mean temp of the coldest month")
plot(depth, pred.warm$fit[,'MAT'], type = 'l', ylab = 'T [C]', main = "Mean temp of the warmest month")
plot(depth, pred.precip$fit[,'MAT'], type = 'l', ylab = 'Precip [mm/year]', main = "Mean annual precipitation")

#Plot all three using age
plot(age, pred.cold$fit[,'MAT'], type = 'l', ylab = 'T [C]', main = "Mean temp of the coldest month")
plot(age, pred.warm$fit[,'MAT'], type = 'l', ylab = 'T [C]', main = "Mean temp of the warmest month")
plot(age, pred.precip$fit[,'MAT'], type = 'l', ylab = 'Precip [mm/year]', main = "Mean annual precipitation")
```

Check the quality of our reconstruction by examining whether the shortest distance between our fossil and modern assemblages is typical of similar assemblages in the calibration set.

```{r, echo=FALSE}
modern[is.na(modern)] <- 0
```


```{r}
layout(matrix(c(1,2,3), ncol = 1))
qual<- quantile(paldist(modern, dist.method='sq.chord'), prob = c(0.05, 0.1))
plot(depth, pred.cold$dist.n[,1], ylab=" Square-Chord distance", xlab="Depth") #Values seem high...
abline(h=qual, col=c("orange", "red"))
plot(depth, pred.warm$dist.n[,1], ylab="Square-Chord distance", xlab="Depth") #Values seem high...
abline(h=qual, col=c("orange", "red"))
plot(depth, pred.precip$dist.n[,1], ylab="Square-Chord distance", xlab="Depth") #Values seem high...
abline(h=qual, col=c("orange", "red"))
```


###5. Build a standard stratigraphic diagram and compare it to the reconstructions

```{r}
rownames(fossil.per) <- age
rioja::strat.plot(fossil.per, yvar = age, scale.percent = FALSE,
           wa.order = "bottomleft", plot.poly = TRUE, col.poly = "tan", y.rev = TRUE) #Not scaled by percent - be sure to note the difference in scale for each taxa (scaling by percent causes certain taxa to take up too much space for current purposes).
plot(pred.cold$fit[,'MAT'], age, type = 'l', xlab = 'T [C]', main = "Mean temp of the coldest month", ylim = c(12000,0))
plot(pred.warm$fit[,'MAT'], age, type = 'l', xlab = 'T [C]', main = "Mean temp of the warmest month", ylim = c(12000,0))
plot(pred.precip$fit[,'MAT'], age, type = 'l', xlab = 'Precip [mm/year]', main = "Mean annual precipitation", ylim = c(12000,0))
```

It appears a few taxa such as pinus and artemisia may be linked to drier conditions (at least ~12000 yr BP, and quite possibly more so when they occur together). Temperatures also exhibit a distinctive trend around 6000 yr BP which may be linked to spikes in pollen for ostrya, equisetum, and quercus, among others. Patterns are in general difficult to discern due to the use of pollen assemblages rather than single taxa, so further visual inspection reveals little in the way of major patterns linked to single variables. High ecological novelty appears toward the bottom of the core, with the inclusion of artemisia and pinus together.
