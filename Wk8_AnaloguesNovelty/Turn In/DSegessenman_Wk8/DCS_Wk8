#Daniel Segessenman Week 8 Assignment
#Analog Analysis

#Discussion:

#Both Quercus and Ulmus pollen seem to visually match between the strat plot
#and the annual precipitation predicted model. Annual precipitation is predicted
#to steadily fall over time, and the Quercus seems to show a negative correlation
#with that trend and increases over time, while Ulmus shows a positive correlation,
#and seems to decrease with time. Poaceae might be tied to the tmax, as it is
#most common during the mid-time interval, and tmax is also at its highest (it
#does fluctuate a bit) during the mid-time interval.

#The highest dissimilarity comes from the annual precipitation model, but it seems
#the modern is still a solid predictor of fossil taxa and their preferences for
#specific levels of precipitation. The tave and tmax do not show much dissimilarity,
#though both of these variables are predicted to have fluctuated more than precipitation
#in the past.

#Code:

#Load Packages for Analysis
library(neotoma)
library(vegan)
library(analogue)
library(rioja)
library(astrochron) #for pl() function

#Load in climate data and pollen data from NAMPD (North American Pollen Database)
#via Analogue package
data(Climate)
data(Pollen)

#fix error in Climate data
colnames(Climate)[1:3] <- c('tjan', 'tfeb', 'tmar')

#Get Mendota data from Neotoma
mend_ds <- get_dataset(1679)
mend_data <- get_download(mend_ds)

#Extract Pollen data from Mendota data and convert it to proportion
mend_pol <- mend_data[[1]]

#Convert pollen counts to percents for the modern and fossil (mendota) data
mend_pol_pct <- analogue::tran(x = mend_pol$counts, method = 'percent')
nampd_pol_pct <- analogue::tran(x = Pollen, method = 'percent')

#mend_pol_pct <- data.frame(mend_pol_pct)
depths <- mend_pol$sample.meta$depth

#Compare taxa between Mendota pollen and NAMPD and remove those that are not in
#both databases
mend_pol_comp <- compile_taxa(mend_pol_pct, list = "WhitmoreFull")
fossil <- data.frame(mend_pol_comp)
fossil <- fossil[, -16] #removes 'other' column
modern <- nampd_pol_pct[,which(colnames(nampd_pol_pct) %in% colnames(fossil))]
modern <- replace(modern, is.na(modern), 0)

#Create model of modern taxa with average temp for prediction of fossil taxa
model_tave <- rioja::MAT(modern, Climate$tave, k = 5, lean = FALSE)
plot(model_tave)

#Create model of modern taxa with annual precip for prediction of fossil taxa
model_annp <- rioja::MAT(modern, Climate$annp, k = 5, lean = FALSE)
plot(model_annp)

#Create model of modern taxa with max temp for prediction of fossil taxa
model_tmax <- rioja::MAT(modern, Climate$tmax, k = 5, lean = FALSE)
plot(model_tmax)

#Prediction of tave, annp, and tmax of fossil taxa
tave = predict(model_tave, fossil)
annp = predict(model_annp, fossil)
tmax = predict(model_tmax, fossil)

#Cross Validation of tave
cvmodel_tave = rioja::crossval(model_tave, verbose = FALSE)
plot(cvmodel_tave)
pfcvmodel_tave = rioja::performance(cvmodel_tave)
pfcvmodel_tave

#Depth model of tave
plot(depths, tave$fit[,'MAT'], type = 'l', ylab = 'Tave [C]')

#Cross Validation of annp
cvmodel_annp = rioja::crossval(model_annp, verbose = FALSE)
plot(cvmodel_annp)
pfcvmodel_annp = rioja::performance(cvmodel_annp)
pfcvmodel_annp

#Depth model of annp
plot(depths, annp$fit[,'MAT'], type = 'l', ylab = 'AnnP [cm]')

#Cross Validation of tmax
cvmodel_tmax = rioja::crossval(model_tmax, verbose = FALSE)
plot(cvmodel_tmax)
pfcvmodel_tmax = rioja::performance(cvmodel_tmax)
pfcvmodel_tmax

#Depth model of tmax
plot(depths, tmax$fit[,'MAT'], type = 'l', ylab = 'Tmax [C]')

#Rioja plot of Lake Mendota taxa
pl()
m_strat_pl <- strat.plot(fossil, yvar = depths, y.rev = TRUE, plot.line = FALSE,
                plot.poly = TRUE, plot.bar = TRUE, col.bar ="black", col.poly="forestgreen",
                col.poly.line="black", scale.percent=TRUE, xSpace=0.01, x.pc.lab=TRUE, x.pc.omit0=TRUE, las=2)
