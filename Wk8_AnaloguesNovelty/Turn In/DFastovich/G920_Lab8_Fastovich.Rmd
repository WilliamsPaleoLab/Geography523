---
title: "G920_Lab8_Fastovich"
author: "David Fastovich"
date: "November 1, 2018"
output: 
  html_document:
    theme: spacelab
    highlight: pygments
---

### Loading libraries
```{r warning=FALSE, message=FALSE}
library(rioja)
library(neotoma)
library(analogue)
library(palaeoSig)
```

### Loading the North American Modern Pollen Database and the associated climate data
```{r}
data(Pollen)
data(Climate)
```

### Pulling data for Lake Tulane from Neotoma
```{r warning=FALSE, message=FALSE, results='hide'}
# Getting the data and turning the counts into proportions
tul.site <- get_site("*tulane*")
tul.dataset <- get_dataset(tul.site)
tul.down <- get_download(tul.dataset)
tul.poll <- tul.down$`19620`$counts
tul.perc <- (tul.poll/rowSums(tul.poll))

# Compiling the taxa to match the column names in the NAMPD
tul.comp <- compile_taxa(tul.perc, list.name = "WhitmoreFull")
tul.comp <- tul.comp[,-41] # Removing the "Other" column
```

### Working the data to ensure that the NAMPD only has taxa that occur in the fossil pollen dataset. Then turning this into proportions
```{r}
colnames(Climate)[1:3] <- c('tjan','tfeb','tmar') # There is an issue with the Climate dataset - the first three columns are named incorrectly
Pollen.sel <- Pollen[,which(colnames(Pollen) %in% colnames(tul.comp))] # Selecting the taxa that are present in the fossil pollen dataset
Pollen.sel[is.na(Pollen.sel)] <- 0
Pollen.sel.prop <- (Pollen.sel/rowSums(Pollen.sel))
```

### Reconstruction annual temperature, July precipitation, and December precipitation
#### Starting with the models
```{r warning=FALSE, message=FALSE, results='hide'}
mat.tave <- MAT(Pollen.sel.prop, Climate$tave, k = 5, lean = FALSE) # MAT model for average temperature using 5 analogs
mat.jul.prec <- MAT(Pollen.sel.prop, Climate$pjul, k = 5, lean = FALSE) # MAT model for July precipitation using 5 analogs
mat.dec.prec <- MAT(Pollen.sel.prop, Climate$pdec, k = 5, lean = FALSE) # MAT model for December precipitation using 5 analogs
```

### Cross validating and checking performance
```{r warning=FALSE, message=FALSE, results='hide'}
mat.tave.cross <- rioja::crossval(mat.tave) # Cross-validation for the MAT average temperature
mat.tave.perf <- rioja::performance(mat.tave.cross) # Model performance for the MAT average temperature 

mat.jul.prec.cross <- rioja::crossval(mat.jul.prec) # Cross-validation for the MAT July precipitation
mat.jul.prec.perf <- rioja::performance(mat.jul.prec.cross) # Model performance for the MAT July precipitation

mat.dec.prec.cross <- rioja::crossval(mat.dec.prec) # Cross validation for the MAT December precipitation
mat.dec.prec.perf <- rioja::performance(mat.dec.prec.cross) # Model performance for the MAT December precipitation

par(mfrow = c(1,3)) # Setting up the cross validation plots
plot(mat.tave.cross, main = "Average Temperature")
plot(mat.jul.prec.cross, main = "July Precipitation")
plot(mat.dec.prec.cross, main = "December Precipiation")
```

Model                  | RMSE                              | RMSE0
---------------------- | --------------------------------- | ----------------------------------
Average Temperature    | `r mat.tave.perf$object[1,1]`     | `r mat.tave.perf$RMSE0`
July Precipitation     | `r mat.jul.prec.perf$object[1,1]` | `r mat.jul.prec.perf$RMSE0`
December Precipitation | `r mat.dec.prec.perf$object[1,1]` | `r mat.dec.prec.perf$RMSE0`

### Taking these environmental variables and plotting them with the pollen dataset to determine if any individual taxa are responsible for much of the observed changed in the environmental variables
#### Starting by generating predictions for the environmental variables of interest
```{r}
tul.tav <- predict(mat.tave, newdata = tul.comp)
tul.jul.prec <- predict(mat.jul.prec, newdata = tul.comp)
tul.dec.prec <- predict(mat.dec.prec, newdata = tul.comp)
```

#### Plotting them next to a compiled list of taxa from Lake Tulane
```{r warning=FALSE, message=FALSE}
# Compiling taxa for easier visulation
tul.comp.p25 <- compile_taxa(tul.perc, list.name = "P25")
tul.comp.p25 <- as.data.frame(tul.comp.p25[,-15]) # Removing the "Other" column
tul.comp.p25 <- tul.comp.p25[,colSums(tul.comp.p25) > 2] # Getting rid of taxa that don't exceed a proprotion of 2%
tul.comp.p25$`Average Temperature` <- tul.tav$fit[,1] # Adding average temperature to the pollen data frame for easy plotting
tul.comp.p25$`July Precipitation` <- tul.jul.prec$fit[,1] # Adding July precipitation to the pollen data frame for easy plotting
tul.comp.p25$`December Precipitation` <- tul.dec.prec$fit[,1] # Adding December precipitation to the pollen data frame for easy plotting
tul.comp.p25$`Minimum Dissimilarity` <- apply(tul.tav$dist.n, 1, min) # Adding minimum dissimilarity to the pollen data

strat.plot(tul.comp.p25, yvar = tul.down$`19620`$chronologies$`Jacobson et al. 2012`$age, y.rev = TRUE)
```

* Several large changes in temperature appear to be closely related to the abundance of **Pinus**
* Neither July precipitation nor December precipitation appear to be closely related to any one specific plant taxa
* Minimum dissimilarity has two large spikes one occurring at 17.3 ka where minimum dissimilarity increases to 0.7, well above the threshold for a vegetation assemblage to be considered no-analog. Similarly, minimum dissimilarity reaches a local high of 0.45 at 52.1 ka. The high minimum dissimilarity at these two points in time suggest that the reconstructed environmental variables maybe highly different from true environmental conditions.