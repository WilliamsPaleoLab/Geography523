---
title: "WA Partial Least Squares"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

###1. Comparison of transfer functions

**1).Reconstruct pH from diatom data from Round Loch of Glenhead**

```{r, include = FALSE, echo = FALSE}
library(rioja)
library(palaeoSig)
data(arctic.pollen)
data(arctic.env)
```

```{r, results = "hide"}
#Data extraction
data(SWAP)
data(RLGH)
ph <- SWAP[[2]]
mod.spec <- SWAP[[1]]
fossil.spec <- RLGH[[1]]
depth <- RLGH[[2]]
#Convert to proportions
mod.spec <- mod.spec/rowSums(mod.spec)
fossil.spc <- fossil.spec/rowSums(fossil.spec)
#Weighted averaging model
ph.wa <- rioja::WA(sqrt(mod.spec), ph, lean = FALSE)
ph.wa.cal <- rioja::crossval(ph.wa, method = "lgo")
#MAT NEED TO SEE HOW TO EVALUATE THE MODEL, RMSEP?
ph.mat <- rioja::MAT(sqrt(mod.spec), ph, lean = FALSE)
ph.mat.cal <- rioja::crossval(ph.mat, method = "lgo")
#Using weighted averaging partial least squares
ph.wapls <- WAPLS(sqrt(mod.spec), ph)
ph.wapls.cal <- rioja::crossval(ph.wapls)
#Evaluate models (WA, MAT, WAPLS)
ph.mat.cal
ph.wa.cal
ph.wapls.cal
```

The first two coefficients should be included in the WAPLS model (RMSE begins to increase at component 3, indicating overfitting). 

**2). Compare the reconstructions (using plots)**

```{r}
#Scatter plots
layout(matrix(c(1,2,1,2,3,3,3,3), byrow = TRUE, ncol = 2))
plot(ph.mat.cal, main = "MAT")
plot(ph.wa.cal, main = "WA")
plot(ph.wapls.cal, main = "WAPLS")
```

All three models seem to hold up under the calibration, but the WAPLS model appears to have the smallest residuals (followed by the WA model) between observed and predicted values using the leave-one-out method.

```{r}
#Time series plots
ph.mat.pred <- predict(ph.mat.cal, sqrt(fossil.spec))
ph.wa.pred <- predict(ph.wa.cal, sqrt(fossil.spec))
ph.wapls.pred <- predict(ph.wapls.cal, sqrt(fossil.spec))

layout(matrix(c(1,1,2,2,3,3), byrow = FALSE, ncol = 3))
plot(depth$Age ~ ph.mat.pred$fit[,1], main = "MAT", ylim = c(20,0), ylab = "Age (yrs since 1992)", xlab = "pH", type = 'l', xlim = c(4.6, 5))
plot(depth$Age ~ ph.wa.pred$fit[,1], main = "WA", ylim = c(20,0), ylab = "Age (yrs since 1992)",  xlab = "pH", type = 'l', xlim = c(4.6, 5))
plot(depth$Age ~ ph.wapls.pred$fit[,2], main = "WAPLS", ylim = c(20,0), ylab = "Age (yrs since 1992)", xlab = "pH", type = 'l', xlim = c(4.6, 5))
```

The WA and WAPLS models appear to show similar trends, but with reconstructed pH being consistently slightly lower for the WAPLS model (likely because components which were overfit to the training set were removed from the WAPLS model). The MAT model did not show much change; this lack of demonstrated trends in spite of changes in the species assemblages were likely due to the assemblages being too dissimilar to the assemblages in the training set.

**3). Calculate correlations among the three reconstructions**

```{r}
mods.cor <- data.frame(ph.mat.pred$fit[,1], ph.wa.pred$fit[,1], ph.wapls.pred$fit[,2])
colnames(mods.cor) <- c("MAT", "WA", "WAPLS")
cor(mods.cor)
```

WA and WAPLS are very highly correlated with each other and both similarly less so with MAT.

**4). How many analogues does MAT use?**

```{r}
ph.mat.cal
```

5 (k = 5)

###2. Spatial autocorrelation

**Run and cross-validate MAT and WA transfer functions for July temp and July sunshine**

```{r, warnings = FALSE, results = "hide"}
#MAT temp
mod.pollen <- arctic.pollen/rowSums(arctic.pollen)
temp.mat <- rioja::MAT(sqrt(mod.pollen), arctic.env$tjul, lean = FALSE, k = 5)
temp.mat.cal <- rioja::crossval(temp.mat)
#MAT sun
sun.mat <- rioja::MAT(sqrt(mod.pollen), arctic.env$sjul, lean = FALSE, k = 5)
sun.mat.cal <- rioja::crossval(sun.mat)

#WA temp
temp.wa <- rioja::WA(sqrt(mod.pollen), arctic.env$tjul, lean = FALSE)
temp.wa.cal <- rioja::crossval(temp.wa)
#WA sun
sun.wa <- rioja::WA(sqrt(mod.pollen), arctic.env$sjul, lean = FALSE)
sun.wa.cal <- rioja::crossval(sun.wa)
```

```{r}
layout(matrix(c(1,2,3,4), byrow = TRUE, ncol = 2))
plot(temp.mat.cal, main = "July Temp (MAT)")
plot(sun.mat.cal, main = "July Sun (MAT)")
plot(temp.wa.cal, main = "July Temp (WA)")
plot(sun.wa.cal, main = "July Sun (WA)")

temp.mat.cal
temp.wa.cal
sun.mat.cal
sun.wa.cal
```

**Use random data to train the transfer function (and compare it to the TA's trained on July temp and July sunshine)**

```{r, warnings=FALSE, results = "hide"}
wa.rand <- list()
for(i in 1:999) {
  wa.rand[[i]] <- rioja::WA(sqrt(mod.pollen), runif(nrow(arctic.pollen),0,1)) 
} #Run random WA for climate variables 999 times
wa.rand.cal <- list()
for (i in 1:15) {
  wa.rand.cal[[i]] <- rioja::crossval(wa.rand[[i]])
} #Cross-validate - would take too long to do all of them, so we will just do 15 instead

mat.rand <- list()
for(i in 1:20) {
  mat.rand[[i]] <- rioja::MAT(sqrt(mod.pollen), runif(nrow(arctic.pollen),0,1), lean = FALSE) 
} #Run random MAT for climate variables 999 times (actually, it takes too long so I will just do 20)
mat.rand.cal <- list()
for (i in 1:15) {
  mat.rand.cal[[i]] <- rioja::crossval(mat.rand[[i]])
} #Cross-validate - would take too long to do all of them, so we will just do 15 instead

#Compare random data transfer functions to real data transfer functions
```

```{r}
summary(temp.mat.cal)
summary(sun.mat.cal)
summary(temp.wa.cal)
summary(sun.wa.cal)
summary(mat.rand.cal[[1]]) #Random MAT examples
summary(mat.rand.cal[[2]])
summary(mat.rand.cal[[3]])
summary(wa.rand.cal[[1]]) #Random WA examples
summary(wa.rand.cal[[2]])
summary(wa.rand.cal[[3]])
```


The R^2 values for the transfer functions trained on real data consistently showed higher correlation for July temperature than July sunshine. However, the transfer functions trained on random data fairly consistently showed much lower values (lower variance explained) than the models trained on actual environmental parameters.

###3. Compare our previous transfer functions with WAPLS

**Reconstruct July temperature and Jan temperature using MAT, WA, and WAPLS**

```{r, echo = FALSE, include = FALSE, warnings = FALSE}
library(analogue)
library(neotoma)
data(Pollen)
data(Climate)
```

Data cleaning. Let's get this stuff ready first.

```{r}
#Accessing the modern pollen data and getting it ready
pollen <- Pollen
colnames(pollen) <- tolower(colnames(pollen))
climate <- Climate
clim.names <- colnames(climate)
clim.names[1:3] <- c("tjan", "tfeb", "tmar")
colnames(climate) <- clim.names
pollen[is.na(pollen)] <- 0

#Accessing the site data and cleaning it
glimm.site <- get_site(sitename = "Glimmerglass Lake")
glimm <- get_download(glimm.site)
ages <- glimm[[1]]$chronologies$`Blois et al. 2011`$age #Ages
#Change to proportions for fossil set
fossil.pollen <- replace(glimm[[1]]$counts, is.na(glimm[[1]]$counts),0)
fossil.per <- (fossil.pollen/rowSums(fossil.pollen))*100
#Exclude pollen <2%
pollen.sum <- colSums(fossil.per)
fossil.per <- fossil.per[,pollen.sum > 2]
colnames(fossil.per) #These taxa remain
colnames(fossil.per) <- tolower(colnames(fossil.per))

#Remove aquatics
fossil.per <- fossil.per[,-5]
fossil.per <- fossil.per[,-24]
#Change column names in fossil set so they match the modern set
colnames(fossil.per)
colnames(pollen)
fossil.names <- c("acsacnum", "alnusx", "artemisia", "betula", "pinusx", "pinusx", "pinusx", "quercus", "tilia", "tsugax", "abies", "ambrosia", "polypod", "juglansx", "piceax", "amaranthaceae", "asterx", "fraxinux", "ostrycar", "unknown", "ulmus", "dryopteris", "equisetum")
colnames(fossil.per) <- fossil.names #Fix fossil names
fossil.per <- (fossil.per/rowSums(fossil.per))*100 #Make sure the percentages add up to 100%
```




```{r, warning = FALSE, results = "hide"}
#MAT
jul.mat <- rioja::MAT(sqrt(pollen), climate$tjul, lean = FALSE)
jan.mat <- rioja::MAT(sqrt(pollen), climate$tjan, lean = FALSE)
jul.mat.cal <- rioja::crossval(jul.mat)
jan.mat.cal <- rioja::crossval(jan.mat)

#WA
jul.wa <- rioja::WA(sqrt(pollen), climate$tjul, lean = FALSE)
jan.wa <- rioja::WA(sqrt(pollen), climate$tjan, lean = FALSE)
jul.wa.cal <- rioja::crossval(jul.wa)
jan.wa.cal <- rioja::crossval(jan.wa)

#WAPLS
jul.wapls <- rioja::WAPLS(sqrt(pollen), climate$tjul, lean = FALSE)
jan.wapls <- rioja::WAPLS(sqrt(pollen), climate$tjan, lean = FALSE)
jul.wapls.cal <- rioja::crossval(jul.wapls)
jan.wapls.cal <- rioja::crossval(jan.wapls)
```


```{r}
#Let's see how many components we should include in WAPLS TF
summary(jul.wapls.cal) #Let's include 2 components (RMSEP fails to increase >10% past this point). We can also try with 4 (R^2 starts to decrease past 4) as well.
summary(jan.wapls.cal) #Let's include 2 components (RMSEP does not decrease by ~10% from comp2 - comp 3)
```

We will keep 2 components for both WAPLS transfer functions. Let's see how all transfer functions compare to each other.

```{r}
summary(jul.mat.cal)
summary(jan.mat.cal)
summary(jul.wa.cal)
summary(jan.wa.cal)
```

```{r}
layout(matrix(c(1,2,3,4,5,6), byrow = TRUE, ncol = 2))
plot(jul.mat.cal, main = "July Temp MAT")
plot(jan.mat.cal, main = "Jan Temp MAT")
plot(jul.wa.cal, main = "July Temp WA")
plot(jan.wa.cal, main = "Jan Temp WA")
plot(jul.wapls.cal, main = "July Temp WAPLS")
plot(jan.wapls.cal, main = "Jan Temp WAPLS")
```

**Reconstructions**
```{r}
jul.mat.pred <- predict(jul.mat.cal, fossil.per)
jan.mat.pred <- predict(jan.mat.cal, fossil.per)
jul.wa.pred <- predict(jul.wa.cal, fossil.per)
jan.wa.pred <- predict(jan.wa.cal, fossil.per)
jul.wapls.pred <- predict(jul.wapls.cal, fossil.per)
jan.wapls.pred <- predict(jan.wapls.cal, fossil.per)
jul.mat.pred

#Let's plot the reconstructions
layout(matrix(c(1,2,1,2), byrow = TRUE, ncol = 2))
#Jul MAT
plot(ages ~ jul.mat.pred$fit[,1], type = 'l', ylim = c(12000,0), ylab = "Age (cal. yr BP)", xlab = "July Temperatures (C)", main =  "July Temperatures MAT")
#Jan Mat
plot(ages ~ jan.mat.pred$fit[,1], type = 'l', ylim = c(12000,0), ylab = "Age (cal. yr BP)", xlab = "Jan Temperatures (C)", main =  "January Temperatures MAT")
#Jul WA
plot(ages ~ jul.wa.pred$fit[,1], type = 'l', ylim = c(12000,0), ylab = "Age (cal. yr BP)", xlab = "July Temperatures (C)", main =  "July Temperatures WA")
#Jan WA
plot(ages ~ jan.wa.pred$fit[,1], type = 'l', ylim = c(12000,0), ylab = "Age (cal. yr BP)", xlab = "January Temperatures (C)", main =  "January Temperatures WA")
#Jul WAPLS
plot(ages ~ jul.wapls.pred$fit[,2], type = 'l', ylim = c(12000,0), ylab = "Age (cal. yr BP)", xlab = "July Temperatures (C)", main =  "July Temperatures WAPLS")
#Jan WAPLS
plot(ages ~ jan.wapls.pred$fit[,2], type = 'l', ylim = c(12000,0), ylab = "Age (cal. yr BP)", xlab = "Jan Temperatures (C)", main =  "January Temperatures WAPLS")
```

All three transfer functions appear to agree with a general peak warming (both Jan and July) roughly 8000 years ago, with cooler temperatures ~12000 and present. WA and WAPLS agree more closely, and MAT shows some trends that do not agree with the other reconstructions (i.e. warming trend in July from 4000 to present). WAPLS showed the most extreme cold temperatures in January.

WA and WAPLS transfer functions are calculated in a way that's similar than MAT, which explains the closer agreement between those models than between the MAT. Jan and July temperatures appear to be more in sync (in terms of relative change in temperature) in the WA and WAPLS models, while in MAT there are some discrepencies between the trends in the two. This is likely because WA's calculate the species optima for each climate variable for the reconstruction, and since the same fossil set is used, we end up having a very similar pattern (as long as July and Jan temperatures are correlated in the modern set, the differences between species optima for pairs of species are similar for each month, and the ranges are similar for the same species between months). On the other hand, MAT uses distance from modern analogues, which may result in a situation where the similar assemblages can describe different climate conditions in the training set, and the magnitude of the differences between climate conditions explained by each analogue is different between months.

**Compare correlations between Jan and Jul temps for each reconstruction**

```{r}
#WA
wa.qual <- cbind(jan.wa.pred$fit[,1], jul.wa.pred$fit[,1])
colnames(wa.qual) <- c("Jan.Opt", "Jul.Opt")

#WAPLS
wapls.qual <- cbind(jan.wapls.pred$fit[,2], jul.wapls.pred$fit[,2])
colnames(wapls.qual) <- c("Jan.Opt", "Jul.Opt")
wapls.qual

#Let's compare the two
cor(wa.qual)
cor(wapls.qual)
```

By evaluating the correlations between Jan and July temperature reconstructions for both the WAPLS and WA models we can conclude that the WAPLS transfer function appeared to have optima that were less correlated than our weighted averaging model.

```{r}
#MAT
mat.qual <- cbind(jan.mat.pred$diagnostics, jul.mat.pred$diagnostics)
colnames(mat.qual) <- c("Jan.Stdev", "Jan.minD", "Jul.StDev", "Jul.minD")
mat.qual
```

The correlation between Jan and July temperatures in the MAT appears to be a 1 to 1 match. This indicates that the same analogues were used for both Jan and July temperatures. The difference in the temperature reconstructions for both months must be a result of similar assemblages being associated with different temperatures for each month, and those differences in temperatures between analogues having differences in magnitude in each model.

```{r}
cor(data.frame(mat.qual$Jan.Stdev, mat.qual$Jan.minD))
cor(data.frame(mat.qual$Jul.StDev, mat.qual$Jul.minD))
```


Analgue quality (minimum Square Chord distance between the sample and the closest analogue) did not appear to have any discernable relationship to the sample standard deviation for either reconstruction.

```{r}
jan.mat.pred$match.name
jul.mat.pred$match.name
```

$match.name shows that the same analogues were chosen for both Jan and July temperatures. 

Let's evaluate the correlations between all models

```{r}
all.cor <- data.frame(jul.mat.pred$fit[,1], jan.mat.pred$fit[,1], jul.wa.pred$fit[,1], jan.wa.pred$fit[,1], jul.wapls.pred$fit[,2], jan.wapls.pred$fit[,2])
colnames(all.cor) <- c("Jul.MAT", "Jan.MAT", "Jul.WA", "Jan.WA", "Jul.WAPLS", "Jan.WAPLS")
cor(all.cor)
```

The highest correlations are between the WA and WAPLS models (for the same month), and also between the Jan and July reconstructions for both WA models. Jan and July reconstructions using MAT are not as highly correlated as WA, and Jan and July reconstruction are even less correlated (slightly) between the WAPLS models.