---
title: "Week 10 Lab"
output: html_document
---

```{r}
# download packages and data
library(rioja)
library(palaeoSig)
data(SWAP)
data(RLGH)
```

**Question 1**
```{r}
# runs WAPLS model and gets summary
swap_WAPLS <- rioja::WAPLS(SWAP$spec, SWAP$pH, npls = 2)
swap_WAPLS_sum <- summary(swap_WAPLS)

# Picks correct wapls
crossval(swap_WAPLS) # 2 is correct

# runs MAT and WA
swap_MAT <- rioja::MAT(SWAP$spec, SWAP$pH)
swap_WA <- rioja::WA(SWAP$spec, SWAP$pH)

# plots models
plot(swap_WAPLS, xlab = "Observed", ylab = "Predicted")
plot(swap_MAT, xlab = "Observed", ylab = "Predicted")
plot(swap_WA, xlab = "Observed", ylab = "Predicted")

# predict models
swap_WAPLS_pred <- predict(swap_WAPLS, newdata = RLGH$spec)
swap_WA_pred <- predict(swap_WA, newdata = RLGH$spec)
swap_MAT_pred <- predict(swap_MAT, newdata = RLGH$spec)

# time series plot
plot(y = swap_WAPLS_pred$fit[,2], x = RLGH$depths$Age, type = "l", col = "red", xlab = "Age", ylab = "Predicted pHs", main = "Time Series Plot")
lines(y = swap_WA_pred$fit[,1], x = RLGH$depths$Age, type = "l", col = "green")
lines(y = swap_MAT_pred$fit[,2], x = RLGH$depths$Age, type = "l", col = "blue")
legend("topleft", legend=c("WAPLS", "WA", "MAT"), col=c("red", "green", "blue"), lty = c(1, 1, 1))

# correlations among three reconstructions
all_model_preds <- data.frame(swap_WAPLS_pred$fit[,2], swap_WA_pred$fit[,1], swap_MAT_pred$fit[,2]) # creates data frame of all models
colnames(all_model_preds) <- c("WAPLS", "WA", "MAT") # names data frame columns
cor(all_model_preds) # finds correlations between columns
```
There is the highest correlation between WA and WAPLS, which makes sense because they are part of the same family of models. MAT uses 5 analogues by default.


**Question 2**

```{r}
data("arctic.pollen")
data("arctic.env")
rds_sjul <- readRDS("sjul.RDS")
rds_tjul <- readRDS("tjul.RDS")
rds_tjul_short <- c(rds_tjul$sim1)

# Run and cross-validate MAT transfer functions for July temperature and sunshine
arctic_MAT_tjul <- rioja::MAT(arctic.pollen, arctic.env$tjul, lean=FALSE)
arctic_MAT_tjul_cv <- rioja::crossval(arctic_MAT_tjul)

arctic_MAT_sjul <- rioja::MAT(arctic.pollen, arctic.env$sjul, lean=FALSE)
arctic_MAT_sjul_cv <- rioja::crossval(arctic_MAT_sjul)

# Run and cross-validate WA transfer functions for July temperature and sunshine
arctic_WA_tjul <- rioja::WA(arctic.pollen, arctic.env$tjul, lean=FALSE)
arctic_WA_tjul_cv <- rioja::crossval(arctic_WA_tjul)

arctic_WA_sjul <- rioja::WA(arctic.pollen, arctic.env$sjul, lean=FALSE)
arctic_WA_sjul_cv <- rioja::crossval(arctic_WA_sjul)

# Creates random data with # of observations in dataset
random_data = matrix(nrow = 828, ncol = 99)
for (i in 1:99){
  i <- runif(828)
  random_data <- cbind(i, random_data)
  }

# Train transfer functions on random data and extract R2
for (i in 1:99){
  arctic_WA_rand <- rioja::WA(arctic.pollen, random_data[,i], lean=FALSE)
  arctic_WA_cv <- rioja::crossval(arctic_WA_rand)
  arctic_WA_perf <- rioja::performance(arctic_WA_cv)
  current_r2_value <- arctic_WA_perf$crossval[1,2]
  r2_values <- append(r2_values, current_r2_value)
}

# histogram of r-squared values for WA
hist(r2_values)
  
# Train transfer functions on random data and extract R2
for (i in 1:99){
  arctic_WA_rand_sp <- rioja::WA(arctic.pollen, rds_tjul@data[,i], lean=FALSE)
  arctic_WA_cv_sp <- rioja::crossval(arctic_WA_rand_sp)
  arctic_WA_perf_sp <- rioja::performance(arctic_WA_cv_sp)
  current_r2_value <- arctic_WA_perf_sp$crossval[1,2]
  r2_values_sp <- append(r2_values, current_r2_value)
}

# histogram of r-squared values for WA
hist(r2_values)

# Train transfer functions on spatial data and extract R2
for (i in 1:99){
  arctic_WA_rand_sp <- rioja::WA(arctic.pollen, rds_tjul[[i]], lean=FALSE)
  arctic_WA_cv_sp <- rioja::crossval(arctic_WA_rand_sp)
  arctic_WA_perf_sp <- rioja::performance(arctic_WA_cv_sp)
  current_r2_value <- arctic_WA_perf_sp$crossval[1,2]
  r2_values_sp <- append(r2_values, current_r2_value)
}

# histogram of r-squared values for WA
hist(r2_values_sp)

# Removes duplicates  
dup <- duplicated(rds_tjul)
my.species.new <- rds_tjul[!dup,]

```
The r2 values are lower with the spatial data than the random data.


**Question 3**

```{r}
# Adds package
library(analogue)

# Adds data
data(arctic.pollen)
data(arctic.env)
data(arctic)

# Takes square root of pollen data
arctic_sqrt <- sqrt(arctic.pollen)


# Runs models constrained by July temp
# Runs WA 
arctic_WA_jul <- rioja::WA(arctic_sqrt, arctic.env$tjul)
# Predict July temperatures
arctic_WA_predict <- predict(arctic_WA_jul)

# Runs WAPLS 
arctic_WAPLS_jul <- rioja::WAPLS(arctic_sqrt, arctic.env$tjul)
# Predict July temperatures
arctic_WAPLS_predict <- predict(arctic_WAPLS_jul)

# Runs MAT 
arctic_MAT_jul <- rioja::MAT(arctic_sqrt, arctic.env$tjul)
# Predict July temperatures
arctic_MAT_predict <- predict(arctic_MAT_jul)

# time series plot
plot(y = arctic_WAPLS_predict[,2], x = seq(1,828,1), type = "l", col = "red", ylab = "Predicted July Temperature", main = "Time Series Plot")
lines(y = arctic_WA_predict[,1], x = seq(1,828,1), type = "l", col = "green")
lines(y = arctic_MAT_predict[,2], x = seq(1,828,1), type = "l", col = "blue")
legend("topleft", legend=c("WAPLS", "WA", "MAT"), col=c("red", "green", "blue"), lty = c(1, 1, 1))

# correlations among three reconstructions
arctic_model_preds <- data.frame(arctic_WAPLS_predict[,2], arctic_WA_predict[,1], arctic_MAT_predict[,2]) # creates data frame of all models
colnames(arctic_model_preds) <- c("WAPLS", "WA", "MAT") # names data frame columns
cor(arctic_model_preds) # finds correlations between columns

# Runs models constrained by Jan temp
# Runs WA
arctic_WA_jan <- rioja::WA(arctic_sqrt, arctic.env$tjan)
# Predict Jan temperatures
arctic_WA_predict_jan <- predict(arctic_WA_jan)

# Runs WAPLS
arctic_WAPLS_jan <- rioja::WAPLS(arctic_sqrt, arctic.env$tjan)
# Predict Jam temperatures
arctic_WAPLS_predict_jan <- predict(arctic_WAPLS_jan)

# Runs MAT
arctic_MAT_jan <- rioja::MAT(arctic_sqrt, arctic.env$tjan)
# Predict Jan temperatures
arctic_MAT_predict_jan <- predict(arctic_MAT_jan)

# time series plot
plot(y = arctic_WAPLS_predict_jan[,2], x = seq(1,828,1), type = "l", col = "red", ylab = "Predicted January Temperature", main = "Time Series Plot")
lines(y = arctic_WA_predict_jan[,1], x = seq(1,828,1), type = "l", col = "green")
lines(y = arctic_MAT_predict_jan[,2], x = seq(1,828,1), type = "l", col = "blue")
legend("topleft", legend=c("WAPLS", "WA", "MAT"), col=c("red", "green", "blue"), lty = c(1, 1, 1))

# correlations among three reconstructions
arctic_model_preds_jan <- data.frame(arctic_WAPLS_predict_jan[,2], arctic_WA_predict_jan[,1], arctic_MAT_predict_jan[,2]) # creates data frame of all models
colnames(arctic_model_preds_jan) <- c("WAPLS", "WA", "MAT") # names data frame columns
cor(arctic_model_preds_jan) # finds correlations between columns

# calculates optima
arctic_tjul_optima <- analogue::optima(arctic_sqrt, arctic.env$tjul)
arctic_tjan_optima <- analogue::optima(arctic_sqrt, arctic.env$tjan)

plot(arctic_tjan_optima ~ arctic_tjul_optima)

```
There are phases with agreement and other where reconstructions disagree. These time periods likely have more uncertainty in their predictions. The WA and WAPLS are more highly correlated, because the models are based on similar parameters.